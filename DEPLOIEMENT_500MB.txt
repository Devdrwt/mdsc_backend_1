================================================================
  ğŸš€ DÃ‰PLOIEMENT PRODUCTION - UPLOAD VIDÃ‰OS 500MB
================================================================

Date: 13 DÃ©cembre 2025
ProblÃ¨me rÃ©solu: Les grosses vidÃ©os fonctionnent en local mais pas en production

================================================================
  ğŸ”§ MODIFICATIONS EFFECTUÃ‰ES
================================================================

AUGMENTATION DES LIMITES Ã€ 500MB:
âœ… Multer (mediaRoutes): 500MB (au lieu de 150-200MB)
âœ… Express body-parser (server.js): 550MB (au lieu de 210MB)
âœ… mediaService: 500MB pour tous les types de fichiers
âœ… fileController: 500MB pour upload et uploadCourse
âœ… minioService: Seuil multipart Ã  100MB (au lieu de 50MB)

CORRECTION BDD:
âœ… Table user_files: id en AUTO_INCREMENT

================================================================
  ğŸ“‹ DÃ‰PLOIEMENT EN 3 COMMANDES
================================================================

1ï¸âƒ£  Copier le script sur le serveur:
    scp update-production.sh admin@srv1070356:/home/admin/

2ï¸âƒ£  Se connecter au serveur:
    ssh admin@srv1070356

3ï¸âƒ£  ExÃ©cuter le script de mise Ã  jour:
    cd /home/admin
    bash update-production.sh

Le script fait TOUT automatiquement:
  âœ… Pull du dernier code (limites 500MB)
  âœ… Correction de la table user_files
  âœ… Installation des dÃ©pendances
  âœ… Nettoyage des logs
  âœ… RedÃ©marrage du service
  âœ… VÃ©rifications complÃ¨tes

================================================================
  ğŸ§ª TEST APRÃˆS DÃ‰PLOIEMENT
================================================================

1. Surveiller les logs en temps rÃ©el:
   sudo journalctl -u deploy-backend.service -f | grep MINIO

2. Ouvrir le frontend:
   https://mooc.mdscbenin.org

3. Uploader une vidÃ©o de 200-400 MB

4. VÃ©rifier dans les logs:
   ğŸš€ [MINIO] ========== DÃ‰BUT UPLOAD ==========
   ğŸ“Š [MINIO] Taille fichier: {
     bufferSize: 350000000,
     bufferSizeMB: '333.79 MB',
     isLarge: true,
     isPDF: false
   }
   ğŸ“¹ [MINIO] Gros fichier, crÃ©ation d'un stream depuis le buffer...
   âœ… [MINIO] Upload terminÃ© avec succÃ¨s en 45.23s
   ğŸ [MINIO] ========== FIN UPLOAD ==========

================================================================
  ğŸ“Š LIMITES PAR FICHIER
================================================================

Avant (ne fonctionnait pas en production):
  âŒ Multer upload: 150-200MB
  âŒ Express: 210MB
  âŒ Seuil multipart: 50MB

AprÃ¨s (fonctionne maintenant):
  âœ… Multer upload: 500MB
  âœ… Express: 550MB
  âœ… Seuil multipart: 100MB
  âœ… Timeout HTTP: 10 minutes (600 secondes)

Types de fichiers supportÃ©s jusqu'Ã  500MB:
  âœ… VidÃ©os: .mp4, .mov, .avi, .mkv, .webm
  âœ… Audio: .mp3, .wav, .ogg, .m4a
  âœ… Documents: .pdf, .doc, .docx, .ppt, .pptx
  âœ… Images: .jpg, .png, .gif, .webp
  âœ… Packages H5P: .h5p, .zip

================================================================
  âš¡ COMMANDES UTILES
================================================================

# Surveiller les logs (avec G pour aller Ã  la fin)
sudo journalctl -u deploy-backend.service -n 1000

# Logs en temps rÃ©el
sudo journalctl -u deploy-backend.service -f

# Filtrer sur MINIO
sudo journalctl -u deploy-backend.service | grep MINIO

# VÃ©rifier que le code est Ã  jour
cd /home/admin/mdsc_backend_1
git log -1 --oneline
grep "500 \* 1024 \* 1024" src/routes/mediaRoutes.js

# RedÃ©marrer le service
sudo systemctl restart deploy-backend.service

# VÃ©rifier le statut
sudo systemctl status deploy-backend.service

# VÃ©rifier le port 5000
sudo netstat -tlnp | grep :5000

================================================================
  ğŸ†˜ DÃ‰PANNAGE
================================================================

PROBLÃˆME: Upload Ã©choue avec "File too large"
SOLUTION: VÃ©rifier les limites dans le code
  cd /home/admin/mdsc_backend_1
  grep "fileSize:" src/routes/mediaRoutes.js
  # Devrait afficher: fileSize: 500 * 1024 * 1024

PROBLÃˆME: Timeout pendant l'upload
SOLUTION: VÃ©rifier le timeout HTTP
  cd /home/admin/mdsc_backend_1
  grep "timeout:" src/services/minioService.js
  # Devrait afficher: timeout: 600000 (10 minutes)

PROBLÃˆME: Erreur "Field 'id' doesn't have a default value"
SOLUTION: ExÃ©cuter le script de correction BDD
  cd /home/admin/mdsc_backend_1
  node database/fix_user_files_table.js

PROBLÃˆME: Le code n'est pas Ã  jour
SOLUTION: Forcer la mise Ã  jour
  cd /home/admin/mdsc_backend_1
  git fetch origin production
  git reset --hard origin/production
  sudo systemctl restart deploy-backend.service

================================================================
  âœ… CHECKLIST FINALE
================================================================

Avant le test:
  â–¡ Le script update-production.sh s'est exÃ©cutÃ© sans erreur
  â–¡ Le service deploy-backend.service est actif
  â–¡ Le port 5000 est ouvert
  â–¡ Les logs affichent les limites 500MB

Pendant le test:
  â–¡ Upload d'une vidÃ©o de 200-400 MB dÃ©marre
  â–¡ Les logs MINIO apparaissent
  â–¡ Pas d'erreur "File too large"
  â–¡ Pas de timeout

AprÃ¨s le test:
  â–¡ La vidÃ©o est uploadÃ©e avec succÃ¨s
  â–¡ L'URL MinIO est gÃ©nÃ©rÃ©e
  â–¡ Le fichier est enregistrÃ© en BDD
  â–¡ Le fichier est accessible depuis le frontend

================================================================
  ğŸ¯ RÃ‰SULTAT ATTENDU
================================================================

Upload rÃ©ussi d'une vidÃ©o de 400MB:

ğŸš€ [MINIO] ========== DÃ‰BUT UPLOAD ==========
ğŸ“‹ [MINIO] ParamÃ¨tres reÃ§us: {
  objectName: 'modules/video-1734096789-456.mp4',
  contentType: 'video/mp4',
  fileType: 'object',
  hasBuffer: true,
  hasPath: false,
  fileSize: 419430400
}
ğŸ“Š [MINIO] Taille fichier: {
  bufferSize: 419430400,
  bufferSizeMB: '400.00 MB',
  isLarge: true,
  isPDF: false
}
ğŸ“¹ [MINIO] Gros fichier, crÃ©ation d'un stream depuis le buffer pour multipart upload...
âœ… [MINIO] Stream crÃ©Ã© depuis buffer pour multipart upload
ğŸ“¤ [MINIO] Upload vers: {
  bucket: 'videos-mdsc',
  objectName: 'modules/video-1734096789-456.mp4',
  fileSize: 419430400,
  useStream: true,
  contentType: 'video/mp4'
}
ğŸ”„ [MINIO] DÃ©marrage de putObject...
â³ [MINIO] Upload en cours... 5.0s Ã©coulÃ©es
â³ [MINIO] Upload en cours... 10.0s Ã©coulÃ©es
â³ [MINIO] Upload en cours... 15.0s Ã©coulÃ©es
â³ [MINIO] Upload en cours... 20.0s Ã©coulÃ©es
â³ [MINIO] Upload en cours... 25.0s Ã©coulÃ©es
â³ [MINIO] Upload en cours... 30.0s Ã©coulÃ©es
â³ [MINIO] Upload en cours... 35.0s Ã©coulÃ©es
â³ [MINIO] Upload en cours... 40.0s Ã©coulÃ©es
â³ [MINIO] Upload en cours... 45.0s Ã©coulÃ©es
âœ… [MINIO] Upload terminÃ© avec succÃ¨s en 48.76s
ğŸ‰ [MINIO] Upload complet: {
  bucket: 'videos-mdsc',
  objectName: 'modules/video-1734096789-456.mp4',
  url: 'https://play.min.io/videos-mdsc/modules/video-1734096789-456.mp4',
  size: 419430400
}
ğŸ [MINIO] ========== FIN UPLOAD ==========

================================================================

ğŸš€ TOUT EST PRÃŠT ! Les vidÃ©os jusqu'Ã  500MB devraient maintenant
fonctionner en production comme en local.

ExÃ©cutez le script update-production.sh et testez ! ğŸ‰

================================================================
