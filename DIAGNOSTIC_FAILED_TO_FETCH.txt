================================================================
  üÜò DIAGNOSTIC ERREUR "Failed to fetch" EN PRODUCTION
================================================================

Erreur: Failed to fetch sur https://backendmooc.mdscbenin.org/api/media/upload
Cause probable: CORS, Backend down, ou Nginx

================================================================
  üìã √âTAPE 1: V√âRIFIER QUE LE BACKEND R√âPOND
================================================================

Depuis votre machine locale:

curl -I https://backendmooc.mdscbenin.org/health

‚úÖ R√âSULTAT ATTENDU:
HTTP/2 200
content-type: application/json

‚ùå SI ERREUR:
- "Connection refused" ‚Üí Backend down ou port ferm√©
- "SSL certificate problem" ‚Üí Probl√®me certificat
- "Could not resolve host" ‚Üí Probl√®me DNS
- Timeout ‚Üí Backend trop lent ou bloqu√©


================================================================
  üìã √âTAPE 2: TESTER L'ENDPOINT D'UPLOAD
================================================================

curl -X OPTIONS https://backendmooc.mdscbenin.org/api/media/upload \
  -H "Origin: https://mooc.mdscbenin.org" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: authorization,content-type" \
  -v

‚úÖ R√âSULTAT ATTENDU:
< HTTP/2 204
< access-control-allow-origin: https://mooc.mdscbenin.org
< access-control-allow-credentials: true
< access-control-allow-methods: GET,POST,PUT,PATCH,DELETE,OPTIONS

‚ùå SI PAS DE HEADER CORS:
‚Üí Probl√®me CORS dans le backend


================================================================
  üìã √âTAPE 3: V√âRIFIER LE SERVICE BACKEND
================================================================

ssh admin@srv1070356

# V√©rifier que le service tourne
sudo systemctl status deploy-backend.service

# V√©rifier le port 5000
sudo netstat -tlnp | grep :5000

# Voir les derniers logs
sudo journalctl -u deploy-backend.service -n 50 --no-pager


================================================================
  üìã √âTAPE 4: V√âRIFIER NGINX
================================================================

Sur le serveur:

# V√©rifier la config Nginx
sudo nginx -t

# Voir les logs d'erreur Nginx
sudo tail -100 /var/log/nginx/error.log

# Voir les logs d'acc√®s
sudo tail -100 /var/log/nginx/access.log | grep upload


================================================================
  üîß CORRECTIONS POSSIBLES
================================================================

PROBL√àME 1: Backend down
-------------------------
ssh admin@srv1070356
cd /home/admin/mdsc_backend_1
sudo systemctl restart deploy-backend.service
sudo journalctl -u deploy-backend.service -f


PROBL√àME 2: CORS mal configur√©
-------------------------------
Sur le serveur:
cd /home/admin/mdsc_backend_1
cat .env | grep FRONTEND_URL

‚úÖ Devrait contenir:
FRONTEND_URL=https://mooc.mdscbenin.org
FRONTEND_URLS=https://mooc.mdscbenin.org

‚ùå Si absent ou incorrect, corriger:
echo "FRONTEND_URL=https://mooc.mdscbenin.org" >> .env
echo "FRONTEND_URLS=https://mooc.mdscbenin.org" >> .env
sudo systemctl restart deploy-backend.service


PROBL√àME 3: Nginx bloque les gros uploads
------------------------------------------
V√©rifier la config Nginx:
sudo cat /etc/nginx/sites-available/default | grep client_max_body_size

‚úÖ Devrait √™tre:
client_max_body_size 600M;

‚ùå Si absent ou trop petit:
sudo nano /etc/nginx/sites-available/default

Ajouter dans le block server:
  client_max_body_size 600M;
  
Puis:
sudo nginx -t
sudo systemctl restart nginx


PROBL√àME 4: Timeouts Nginx trop courts
---------------------------------------
V√©rifier:
sudo cat /etc/nginx/sites-available/default | grep timeout

‚úÖ Devrait contenir (dans le block location /api/):
  proxy_connect_timeout 600s;
  proxy_send_timeout 600s;
  proxy_read_timeout 600s;

‚ùå Si absent:
sudo nano /etc/nginx/sites-available/default

Dans le block location /api/ ajouter:
  proxy_connect_timeout 600s;
  proxy_send_timeout 600s;
  proxy_read_timeout 600s;

Puis:
sudo nginx -t
sudo systemctl restart nginx


PROBL√àME 5: Certificat SSL invalide
------------------------------------
sudo certbot certificates

Si expir√©:
sudo certbot renew
sudo systemctl restart nginx


================================================================
  üìù CONFIGURATION NGINX COMPL√àTE RECOMMAND√âE
================================================================

Fichier: /etc/nginx/sites-available/default

server {
    listen 80;
    server_name backendmooc.mdscbenin.org;
    
    # Redirection HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name backendmooc.mdscbenin.org;

    # SSL
    ssl_certificate /etc/letsencrypt/live/backendmooc.mdscbenin.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/backendmooc.mdscbenin.org/privkey.pem;

    # Limite taille upload
    client_max_body_size 600M;
    client_body_timeout 600s;
    client_header_timeout 600s;

    # Logs
    access_log /var/log/nginx/backend_access.log;
    error_log /var/log/nginx/backend_error.log;

    # API Backend
    location /api/ {
        proxy_pass http://localhost:5000/api/;
        proxy_http_version 1.1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts pour gros uploads
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        # Buffer
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Health check
    location /health {
        proxy_pass http://localhost:5000/health;
        proxy_http_version 1.1;
    }
}


================================================================
  üß™ TEST COMPLET APR√àS CORRECTION
================================================================

1. Tester le health check:
   curl https://backendmooc.mdscbenin.org/health

2. Tester CORS:
   curl -X OPTIONS https://backendmooc.mdscbenin.org/api/media/upload \
     -H "Origin: https://mooc.mdscbenin.org" -v

3. Tester upload (avec un petit fichier):
   curl -X POST https://backendmooc.mdscbenin.org/api/media/upload \
     -H "Authorization: Bearer VOTRE_TOKEN" \
     -F "file=@test.jpg" \
     -F "content_type=image"

4. Depuis le frontend:
   - Ouvrir https://mooc.mdscbenin.org
   - Ouvrir la console (F12)
   - Essayer d'uploader un fichier
   - V√©rifier qu'il n'y a plus "Failed to fetch"


================================================================
  üìä CHECKLIST DE V√âRIFICATION
================================================================

Backend:
  ‚ñ° Service deploy-backend.service actif
  ‚ñ° Port 5000 ouvert (netstat -tlnp | grep :5000)
  ‚ñ° FRONTEND_URL correct dans .env
  ‚ñ° Logs montrent pas d'erreur au d√©marrage

Nginx:
  ‚ñ° Nginx actif (systemctl status nginx)
  ‚ñ° Config valide (nginx -t)
  ‚ñ° client_max_body_size 600M
  ‚ñ° Timeouts >= 600s
  ‚ñ° Certificat SSL valide

R√©seau:
  ‚ñ° Backend accessible depuis internet
  ‚ñ° DNS r√©solu correctement
  ‚ñ° CORS headers pr√©sents dans la r√©ponse OPTIONS

Frontend:
  ‚ñ° URL backend correcte dans .env.local
  ‚ñ° Pas d'erreur console au chargement
  ‚ñ° Token d'authentification pr√©sent


================================================================
  üÜò SI LE PROBL√àME PERSISTE
================================================================

Collecter les informations:

1. Logs backend:
   sudo journalctl -u deploy-backend.service -n 200 > backend.log

2. Logs nginx:
   sudo tail -200 /var/log/nginx/error.log > nginx-error.log
   sudo tail -200 /var/log/nginx/access.log > nginx-access.log

3. Test curl complet:
   curl -X POST https://backendmooc.mdscbenin.org/api/media/upload \
     -H "Origin: https://mooc.mdscbenin.org" \
     -H "Authorization: Bearer TOKEN" \
     -F "file=@test.jpg" \
     -v 2>&1 | tee curl-test.log

4. Config nginx:
   sudo cat /etc/nginx/sites-available/default > nginx-config.txt

5. .env backend:
   cat /home/admin/mdsc_backend_1/.env | grep -E "FRONTEND|PORT" > backend-env.txt


================================================================
