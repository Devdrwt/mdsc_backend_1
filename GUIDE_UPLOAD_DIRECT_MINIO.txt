================================================================
  üìò GUIDE D'INT√âGRATION - UPLOAD DIRECT MINIO
================================================================

Date: 13 D√©cembre 2025
Solution: Upload direct vers MinIO avec URLs pr√©-sign√©es

================================================================
  üéØ PRINCIPE DE FONCTIONNEMENT
================================================================

AVANT (probl√©matique):
  Navigateur ‚Üí Backend Node.js (timeout!) ‚Üí MinIO
  
APR√àS (solution):
  Navigateur ‚Üí Backend (URL sign√©e) ‚Üí Navigateur ‚Üí MinIO (direct!)

AVANTAGES:
  ‚úÖ Pas de timeout r√©seau/navigateur
  ‚úÖ Moins de charge sur le serveur Node.js
  ‚úÖ Upload plus rapide (connexion directe)
  ‚úÖ Barre de progression pr√©cise
  ‚úÖ Fichiers jusqu'√† plusieurs GB possibles

================================================================
  üìÅ FICHIERS MODIFI√âS
================================================================

BACKEND:
  ‚úÖ src/services/minioService.js
     - getPresignedUploadUrl()
     - getPresignedDownloadUrl()
  
  ‚úÖ src/routes/mediaRoutes.js
     - POST /media/upload/presigned-url
     - POST /media/upload/confirm

FRONTEND:
  ‚úÖ src/lib/services/minioUpload.ts (NOUVEAU)
     - uploadFileToMinIO()
     - uploadMultipleFilesToMinIO()

================================================================
  üîß UTILISATION DANS VOTRE COMPOSANT
================================================================

### OPTION 1: Upload simple d'un fichier

```typescript
import { uploadFileToMinIO } from '@/lib/services/minioUpload';
import { useState } from 'react';

function LessonUploadForm() {
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState(0);

  const handleFileUpload = async (file: File, lessonId: number) => {
    setUploading(true);
    setProgress(0);

    const result = await uploadFileToMinIO({
      file,
      contentType: file.type,
      lessonId,
      onProgress: (p) => setProgress(p)
    });

    setUploading(false);

    if (result.success) {
      console.log('‚úÖ Upload r√©ussi:', result.data);
      // Afficher un message de succ√®s
      alert(`Fichier upload√© avec succ√®s!\nURL: ${result.data?.url}`);
    } else {
      console.error('‚ùå Upload √©chou√©:', result.error);
      alert(`Erreur: ${result.error}`);
    }
  };

  return (
    <div>
      <input
        type="file"
        onChange={(e) => {
          const file = e.target.files?.[0];
          if (file) {
            handleFileUpload(file, 123); // Remplacer 123 par lessonId r√©el
          }
        }}
      />
      {uploading && (
        <div>
          <div>Upload en cours... {progress}%</div>
          <progress value={progress} max={100} />
        </div>
      )}
    </div>
  );
}
```

### OPTION 2: Upload multiple avec progression globale

```typescript
import { uploadMultipleFilesToMinIO } from '@/lib/services/minioUpload';

const handleMultipleUpload = async (files: File[], lessonId: number) => {
  const [fileProgress, setFileProgress] = useState<Record<number, number>>({});
  const [overallProgress, setOverallProgress] = useState(0);

  const results = await uploadMultipleFilesToMinIO(files, {
    lessonId,
    onFileProgress: (fileIndex, progress) => {
      setFileProgress(prev => ({ ...prev, [fileIndex]: progress }));
    },
    onOverallProgress: (progress) => {
      setOverallProgress(progress);
    }
  });

  const allSuccess = results.every(r => r.success);
  if (allSuccess) {
    console.log('‚úÖ Tous les fichiers upload√©s');
  } else {
    console.error('‚ùå Certains uploads ont √©chou√©');
  }
};
```

### OPTION 3: Int√©gration dans un composant existant

Si vous avez d√©j√† un composant avec `uploadFile()`, remplacez :

```typescript
// AVANT
const uploadResponse = await uploadFile('/media/upload', formData, onProgress);

// APR√àS
import { uploadFileToMinIO } from '@/lib/services/minioUpload';

const result = await uploadFileToMinIO({
  file: file,
  contentType: contentType,
  lessonId: lessonId,
  onProgress: onProgress
});

if (result.success) {
  // Utiliser result.data.url, result.data.mediaFileId
}
```

================================================================
  üöÄ D√âPLOIEMENT
================================================================

### √âTAPE 1: Backend

Le backend est d√©j√† pouss√© sur production (commit 56acc0e).

Sur le serveur:
```bash
cd /home/admin/mdsc_backend_1
bash update-production.sh
```

OU manuellement:
```bash
cd /home/admin/mdsc_backend_1
git pull origin production
npm install
sudo systemctl restart deploy-backend.service
```

### √âTAPE 2: Frontend

```bash
cd /home/faille0/Documents/mdsc_frontend

# V√©rifier que le fichier existe
ls -la src/lib/services/minioUpload.ts

# Compiler TypeScript (si n√©cessaire)
npm run build

# Commit et push
git add src/lib/services/minioUpload.ts
git commit -m "feat: Upload direct MinIO avec URLs pr√©-sign√©es"
git push origin main
```

### √âTAPE 3: D√©ployer frontend en production

Sur le serveur frontend:
```bash
cd /home/admin/mdsc_frontend
git pull origin main
npm install
npm run build
pm2 restart mdsc-frontend
```

================================================================
  üß™ TEST
================================================================

### Test 1: V√©rifier que les routes existent

```bash
# Tester la g√©n√©ration d'URL pr√©-sign√©e
curl -X POST https://backendmooc.mdscbenin.org/api/media/upload/presigned-url \
  -H "Authorization: Bearer VOTRE_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "fileName": "test-video.mp4",
    "fileType": "video/mp4",
    "contentType": "video/mp4"
  }'

# Devrait retourner:
# {
#   "success": true,
#   "data": {
#     "uploadUrl": "https://...",
#     "objectName": "modules/...",
#     "bucket": "videos-mdsc",
#     "publicUrl": "https://..."
#   }
# }
```

### Test 2: Upload complet depuis le frontend

1. Ouvrir https://mooc.mdscbenin.org
2. Aller sur la page d'ajout de le√ßon
3. S√©lectionner une vid√©o de 100-300 MB
4. Observer la console:
   - "üöÄ [MINIO UPLOAD] D√©but upload direct"
   - "‚úÖ [MINIO UPLOAD] URL pr√©-sign√©e re√ßue"
   - "üìä [MINIO UPLOAD] Progression: X%"
   - "‚úÖ [MINIO UPLOAD] Upload r√©ussi vers MinIO"
   - "‚úÖ [MINIO UPLOAD] Upload confirm√© en BDD"

5. L'upload devrait r√©ussir **m√™me pour les gros fichiers** !

================================================================
  üîç D√âPANNAGE
================================================================

### Probl√®me 1: Erreur CORS sur l'upload vers MinIO

CAUSE: MinIO n'accepte pas l'origin du frontend

SOLUTION:
```bash
ssh admin@srv1070356
sudo mc alias set myminio https://minio.mdscbenin.org ACCESS_KEY SECRET_KEY
sudo mc anonymous set-json /path/to/cors-config.json myminio/videos-mdsc
```

cors-config.json:
```json
{
  "CORSRules": [{
    "AllowedOrigins": ["https://mooc.mdscbenin.org"],
    "AllowedMethods": ["GET", "PUT", "POST"],
    "AllowedHeaders": ["*"]
  }]
}
```

### Probl√®me 2: URL pr√©-sign√©e expir√©e

CAUSE: L'upload prend plus de 2 heures

SOLUTION: Augmenter l'expiration dans le backend:
```javascript
// Dans mediaRoutes.js, ligne ~153
const uploadUrl = await MinioService.getPresignedUploadUrl(bucket, objectName, 14400); // 4 heures
```

### Probl√®me 3: Fichier dans MinIO mais pas en BDD

CAUSE: La confirmation (/upload/confirm) a √©chou√©

SOLUTION: V√©rifier les logs backend:
```bash
sudo journalctl -u deploy-backend.service -f | grep CONFIRM
```

================================================================
  üìä COMPARAISON PERFORMANCES
================================================================

Fichier de 200MB avec connexion 5 Mbps upload:

AVANT (via Node.js):
  ‚ùå Timeout apr√®s 2-5 minutes
  ‚ùå √âchec syst√©matique

APR√àS (direct MinIO):
  ‚úÖ Upload r√©ussi en ~5-7 minutes
  ‚úÖ Progression visible
  ‚úÖ Pas de timeout

================================================================
  ‚úÖ CHECKLIST
================================================================

Backend:
  ‚ñ° Code pouss√© sur production (commit 56acc0e)
  ‚ñ° update-production.sh ex√©cut√©
  ‚ñ° Service red√©marr√©
  ‚ñ° Route /media/upload/presigned-url accessible
  ‚ñ° Route /media/upload/confirm accessible

Frontend:
  ‚ñ° Fichier minioUpload.ts cr√©√©
  ‚ñ° Import√© dans les composants concern√©s
  ‚ñ° Code compil√© (npm run build)
  ‚ñ° D√©ploy√© en production

Test:
  ‚ñ° G√©n√©ration URL pr√©-sign√©e fonctionne (curl test)
  ‚ñ° Upload petit fichier (< 10 MB) r√©ussit
  ‚ñ° Upload gros fichier (> 100 MB) r√©ussit
  ‚ñ° Progression affich√©e correctement
  ‚ñ° Fichier visible dans MinIO
  ‚ñ° Enregistrement en BDD correct

================================================================
  üéØ PROCHAINES √âTAPES
================================================================

1. D√©ployer le backend (update-production.sh)
2. Copier minioUpload.ts dans le frontend
3. Modifier le composant d'upload de le√ßon
4. Tester avec un fichier de 100 MB
5. Tester avec un fichier de 300 MB
6. V√©rifier que tout fonctionne

================================================================

‚úÖ La solution est pr√™te ! Plus de timeout pour les gros fichiers !

================================================================
