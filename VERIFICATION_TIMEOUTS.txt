================================================================
  ‚è±Ô∏è  V√âRIFICATION DES TIMEOUTS - BACKEND & FRONTEND
================================================================

Date: 13 D√©cembre 2025
Probl√®me: Les timeouts peuvent bloquer les uploads de grosses vid√©os

================================================================
  ‚úÖ BACKEND - MODIFICATIONS EFFECTU√âES
================================================================

1. SERVEUR HTTP (src/server.js):
   ‚úÖ server.timeout = 0 (illimit√© pour uploads longs)
   ‚úÖ server.keepAliveTimeout = 65000 (65 secondes)
   ‚úÖ server.headersTimeout = 66000 (66 secondes)

2. MINIO SERVICE (src/services/minioService.js):
   ‚úÖ Transport agent: https.globalAgent (utilise les timeouts par d√©faut)
   ‚ö†Ô∏è  Pas de timeout sp√©cifique configur√© (bon pour uploads longs)

3. MULTER:
   ‚úÖ Pas de timeout configur√© (bon - g√©r√© par le serveur HTTP)

4. EXPRESS BODY-PARSER:
   ‚úÖ Limites: 550MB
   ‚ö†Ô∏è  Pas de timeout sp√©cifique (bon - g√©r√© par le serveur HTTP)

================================================================
  üìã FRONTEND - V√âRIFICATIONS √Ä FAIRE
================================================================

IMPORTANT: V√©rifier les timeouts dans le code frontend !

FICHIERS √Ä V√âRIFIER:
-------------------

1. Configuration Axios (si utilis√©):
   Chercher: axios.create() ou axios.defaults
   V√©rifier: timeout property
   
   ‚ùå MAUVAIS:
   ```javascript
   axios.create({
     timeout: 30000  // 30 secondes - TROP COURT !
   })
   ```
   
   ‚úÖ BON:
   ```javascript
   axios.create({
     timeout: 600000  // 10 minutes pour gros uploads
   })
   ```

2. Configuration Fetch (si utilis√©):
   Chercher: AbortController ou signal
   
   ‚ùå MAUVAIS:
   ```javascript
   const controller = new AbortController();
   setTimeout(() => controller.abort(), 30000); // 30s
   
   fetch(url, {
     signal: controller.signal
   })
   ```
   
   ‚úÖ BON:
   ```javascript
   const controller = new AbortController();
   setTimeout(() => controller.abort(), 600000); // 10 minutes
   
   fetch(url, {
     signal: controller.signal
   })
   ```

3. Composants d'upload:
   Chercher dans: 
   - components/Upload
   - components/Course
   - components/Media
   - pages avec upload de fichiers
   
   V√©rifier:
   - Timeout dans les requ√™tes HTTP
   - onUploadProgress callback
   - Retry logic

================================================================
  üîç COMMANDES POUR CHERCHER LES TIMEOUTS FRONTEND
================================================================

Sur le serveur de production:

cd /home/admin/mdsc_frontend

# Chercher axios timeout
grep -r "timeout:" src/ | grep -v node_modules

# Chercher AbortController
grep -r "AbortController" src/ | grep -v node_modules

# Chercher setTimeout dans contexte d'upload
grep -r "setTimeout.*upload\|upload.*setTimeout" src/ | grep -v node_modules

# Chercher les fichiers de configuration API
find src/ -name "*api*" -o -name "*config*" -o -name "*axios*"

================================================================
  üìù EXEMPLE DE CONFIGURATION RECOMMAND√âE
================================================================

AXIOS (RECOMMAND√â):
-------------------

// src/services/api.js ou src/utils/axios.js
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.REACT_APP_API_URL || 'http://localhost:5000',
  timeout: 600000, // 10 minutes pour les gros uploads
  headers: {
    'Content-Type': 'application/json',
  },
});

// Pour les uploads de fichiers, utiliser un timeout encore plus long
export const uploadFile = (url, formData, onProgress) => {
  return api.post(url, formData, {
    timeout: 900000, // 15 minutes
    headers: {
      'Content-Type': 'multipart/form-data',
    },
    onUploadProgress: (progressEvent) => {
      const percentCompleted = Math.round(
        (progressEvent.loaded * 100) / progressEvent.total
      );
      if (onProgress) {
        onProgress(percentCompleted);
      }
    },
  });
};

export default api;


FETCH (ALTERNATIF):
-------------------

// src/services/upload.js
export const uploadFile = async (url, formData, onProgress) => {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => {
    controller.abort();
  }, 600000); // 10 minutes

  try {
    const response = await fetch(url, {
      method: 'POST',
      body: formData,
      signal: controller.signal,
      // Note: onUploadProgress n'est pas support√© par fetch natif
      // Utiliser axios ou une biblioth√®que pour le progress
    });

    clearTimeout(timeoutId);
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') {
      throw new Error('Upload timeout - Le fichier est trop volumineux');
    }
    throw error;
  }
};

================================================================
  üß™ TEST APR√àS MODIFICATION
================================================================

1. Backend: Red√©marrer et v√©rifier les logs
   cd /home/admin/mdsc_backend_1
   sudo systemctl restart deploy-backend.service
   sudo journalctl -u deploy-backend.service -n 50 | grep -i timeout

   Vous devriez voir:
   ‚è±Ô∏è  Timeouts serveur HTTP configur√©s:
      - server.timeout: 0 (illimit√© pour uploads longs)
      - keepAliveTimeout: 65s
      - headersTimeout: 66s

2. Frontend: Tester upload de grosse vid√©o
   - Uploader une vid√©o de 300-400 MB
   - Surveiller les logs backend en temps r√©el
   - V√©rifier qu'il n'y a pas d'erreur timeout c√¥t√© frontend
   - V√©rifier que l'upload va jusqu'au bout (peut prendre 1-2 minutes)

================================================================
  ‚ö†Ô∏è  ERREURS POSSIBLES
================================================================

ERREUR FRONTEND: "Network Error" ou "timeout exceeded"
‚Üí Le timeout frontend est trop court
‚Üí V√©rifier la configuration axios/fetch dans le frontend

ERREUR BACKEND: "Request Timeout" (408)
‚Üí Le timeout du serveur HTTP est trop court
‚Üí D√©j√† corrig√© avec server.timeout = 0

ERREUR NGINX (en production): "504 Gateway Timeout"
‚Üí Le timeout nginx est trop court
‚Üí V√©rifier /etc/nginx/sites-available/default:
   proxy_connect_timeout 600s;
   proxy_send_timeout 600s;
   proxy_read_timeout 600s;

ERREUR MINIO: "RequestTimeout"
‚Üí Rare, mais peut arriver avec une connexion lente
‚Üí D√©j√† g√©r√© avec https.globalAgent

================================================================
  üìä TIMEOUTS RECOMMAND√âS
================================================================

TYPE                    | TIMEOUT     | RAISON
------------------------|-------------|---------------------------
Serveur HTTP            | 0 (illimit√©)| Uploads tr√®s longs
keepAliveTimeout        | 65s         | Plus que nginx default
headersTimeout          | 66s         | Plus que keepAlive
Axios (normal)          | 600s (10min)| Uploads jusqu'√† 500MB
Axios (upload fichier)  | 900s (15min)| Marge de s√©curit√©
Nginx proxy_timeout     | 600s (10min)| Coh√©rent avec axios
MinIO agent             | Default     | G√©r√© automatiquement

================================================================
  ‚úÖ CHECKLIST FINALE
================================================================

BACKEND:
  ‚ñ° server.timeout = 0 configur√©
  ‚ñ° keepAliveTimeout = 65s configur√©
  ‚ñ° headersTimeout = 66s configur√©
  ‚ñ° Service red√©marr√©
  ‚ñ° Logs affichent les timeouts configur√©s

FRONTEND:
  ‚ñ° Trouver la configuration axios/fetch
  ‚ñ° V√©rifier le timeout (doit √™tre >= 600000ms)
  ‚ñ° Modifier si n√©cessaire
  ‚ñ° Commit et push
  ‚ñ° Rebuild et red√©ployer le frontend

NGINX (si en production):
  ‚ñ° V√©rifier proxy_read_timeout >= 600s
  ‚ñ° V√©rifier proxy_send_timeout >= 600s
  ‚ñ° V√©rifier proxy_connect_timeout >= 600s
  ‚ñ° Red√©marrer nginx si modifi√©

TEST:
  ‚ñ° Upload vid√©o 100MB ‚Üí OK en < 30s
  ‚ñ° Upload vid√©o 300MB ‚Üí OK en < 2min
  ‚ñ° Upload vid√©o 500MB ‚Üí OK en < 3min
  ‚ñ° Pas d'erreur timeout
  ‚ñ° Logs MINIO complets du d√©but √† la fin

================================================================

üìû Si vous voyez une erreur timeout pendant l'upload:

1. V√©rifier d'abord le FRONTEND (axios timeout)
2. V√©rifier ensuite NGINX (proxy_read_timeout)
3. V√©rifier enfin le BACKEND (server.timeout)

================================================================
